{% extends "base.html" %}

{% block content %}
<div class="gratitude-journal bg-primary bg-opacity-10 min-vh-100 py-5">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h1>Gratitude Journal</h1>
                <p class="lead">Take a moment to reflect on the positive things in your life.</p>
                
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body p-4">
                        <h2 class="h4 mb-3">Today's Entry</h2>
                        <small id="current-date" class="text-muted d-block mb-3">{{ now.strftime('%A, %B %d, %Y') }}</small>
                        
                        <form id="journal-form">
                            <!-- Mood Selection -->
                            <div class="form-group mb-4">
                                <label class="form-label fw-bold d-block mb-3">How are you feeling today?</label>
                                <div class="d-flex justify-content-between">
                                    {% for i in range(1, 6) %}
                                    <div class="mood-option text-center" data-value="{{ i }}" role="button" tabindex="0">
                                        <div class="mood-icon">
                                            {% if i == 1 %}üò¢
                                            {% elif i == 2 %}üôÅ
                                            {% elif i == 3 %}üòê
                                            {% elif i == 4 %}üôÇ
                                            {% else %}üòÑ
                                            {% endif %}
                                        </div>
                                        <div class="mood-label">
                                            {% if i == 1 %}Awful{% endif %}
                                            {% if i == 2 %}Not Great{% endif %}
                                            {% if i == 3 %}Neutral{% endif %}
                                            {% if i == 4 %}Good{% endif %}
                                            {% if i == 5 %}Great!{% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="mood-rating" name="mood" value="3">
                            </div>
                            
                            <!-- Gratitude Inputs -->
                            <div class="form-group mb-4">
                                <label class="form-label fw-bold">I'm grateful for...</label>
                                <div class="mb-3">
                                    <input type="text" class="form-control" name="gratitude[]" placeholder="Something you're grateful for">
                                </div>
                                <div class="mb-3">
                                    <input type="text" class="form-control" name="gratitude[]" placeholder="Another thing you're grateful for">
                                </div>
                                <div class="mb-3">
                                    <input type="text" class="form-control" name="gratitude[]" placeholder="One more thing you're grateful for">
                                </div>
                            </div>
                            
                            <!-- Journal Entry -->
                            <div class="form-group mb-4">
                                <label for="journal-entry" class="form-label fw-bold">Journal Entry</label>
                                <textarea class="form-control" id="journal-entry" rows="5" 
                                    placeholder="Write about your day, thoughts, or anything else on your mind..."></textarea>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex justify-content-between">
                                <button type="button" id="save-draft" class="btn btn-outline-secondary">
                                    <i class="bi bi-save me-2"></i>Save Draft
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-journal-check me-2"></i>Save Entry
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Journal Entries List -->
                <div class="mt-5">
                    <h3 class="h5 mb-4">Your Journal Entries</h3>
                    <div id="entries-list">
                        <!-- Entries will be loaded here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.gratitude-journal {
    background: linear-gradient(135deg, #e3f2ff 0%, #f8fbff 100%) !important;
    min-height: 100vh;
}

.mood-option {
    cursor: pointer;
    padding: 15px 10px;
    border-radius: 10px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    text-align: center;
    flex: 1;
    margin: 0 5px;
}

.mood-option.selected {
    background-color: rgba(34, 91, 147, 0.1);
    border-color: #225b93;
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.mood-option:hover {
    transform: translateY(-3px);
    background-color: rgba(34, 91, 147, 0.05);
}

.mood-icon {
    font-size: 2.2rem;
    margin-bottom: 5px;
}

.mood-label {
    font-size: 0.85rem;
    color: #4a5568;
    margin-top: 5px;
}

.mood-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background-color: rgba(34, 91, 147, 0.1);
    color: #1a365d;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    border: 1px solid rgba(34, 91, 147, 0.2);
}

.mood-emoji {
    font-size: 1.1em;
    line-height: 1;
}

.mood-text {
    line-height: 1.2;
}

.journal-entry {
    background: rgba(255, 255, 255, 0.9);
    border-left: 4px solid #4a6cf7;
    border-radius: 0.8rem;
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.journal-entry:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.entry-date {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.entry-mood {
    font-size: 1.5rem;
    margin-right: 0.5rem;
}

.gratitude-list {
    margin-top: 1rem;
    padding-left: 1.25rem;
}

.gratitude-list li {
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.gratitude-list li:last-child {
    border-bottom: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
    
    // Initialize mood selection
    const moodOptions = document.querySelectorAll('.mood-option');
    const moodInput = document.getElementById('mood-rating');
    const journalForm = document.getElementById('journal-form');
    const saveDraftBtn = document.getElementById('save-draft');
    const journalTextarea = document.getElementById('journal-entry');
    const entriesList = document.getElementById('entries-list');
    const gratitudeInputs = Array.from(document.querySelectorAll('input[name="gratitude[]"]'));
    
    // Load entries from localStorage
    let journalEntries = JSON.parse(localStorage.getItem('gratitudeJournalEntries')) || [];
    
    // Set mood function
    function setMood(value) {
        moodInput.value = value;
        moodOptions.forEach(opt => {
            opt.classList.toggle('selected', parseInt(opt.dataset.value) === value);
        });
    }
    
    // Mood selection
    moodOptions.forEach(option => {
        option.addEventListener('click', () => {
            const value = parseInt(option.dataset.value);
            setMood(value);
        });
    });
    
    // Save entry function
    function saveEntry(isDraft = false) {
        const gratitude = [];
        gratitudeInputs.forEach(input => {
            if (input.value.trim()) {
                gratitude.push(input.value.trim());
            }
        });
        
        const entry = {
            id: Date.now(),
            date: new Date().toISOString(),
            mood: parseInt(moodInput.value) || 3,
            gratitude: gratitude,
            entry: journalTextarea.value.trim(),
            isDraft: isDraft
        };
        
        if (!isDraft) {
            journalEntries.unshift(entry);
            showNotification('Entry saved successfully!', 'success');
        } else {
            // Remove any existing draft
            journalEntries = journalEntries.filter(e => !e.isDraft);
            journalEntries.unshift(entry);
            showNotification('Draft saved!', 'info');
        }
        
        localStorage.setItem('gratitudeJournalEntries', JSON.stringify(journalEntries));
        renderEntries();
        
        if (!isDraft) {
            journalForm.reset();
            setMood(3);
        }
    }
    
    // Render entries
    function renderEntries() {
        if (journalEntries.length === 0) {
            entriesList.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-muted">No entries yet. Start your gratitude journal!</p>
                </div>`;
            return;
        }
        
        // Group entries by date
        const entriesByDate = journalEntries.reduce((acc, entry) => {
            if (entry.isDraft) return acc; // Skip drafts in the main list
            
            const date = new Date(entry.date).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            if (!acc[date]) {
                acc[date] = [];
            }
            acc[date].push(entry);
            return acc;
        }, {});
        
        let html = '';
        
        for (const [date, entries] of Object.entries(entriesByDate)) {
            html += `
                <div class="mb-4">
                    <h5 class="text-muted mb-3">${date}</h5>
                    <div class="entries-container">
                        ${entries.map(entry => renderEntry(entry)).join('')}
                    </div>
                </div>`;
        }
        
        entriesList.innerHTML = html || `
            <div class="text-center py-4">
                <p class="text-muted">No entries yet. Start your gratitude journal!</p>
            </div>`;
    }
    
    // Render a single entry
    function renderEntry(entry) {
        const moodEmojis = ['üò¢', 'üôÅ', 'üòê', 'üôÇ', 'üòÑ'];
        const moodTexts = ['Awful', 'Not Great', 'Neutral', 'Good', 'Great!'];
        const moodEmoji = moodEmojis[entry.mood - 1] || 'üòê';
        const moodText = moodTexts[entry.mood - 1] || 'Neutral';
        
        return `
            <div class="journal-entry mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="text-muted small">
                        ${new Date(entry.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div class="mood-badge">
                        <span class="mood-emoji">${moodEmoji}</span>
                        <span class="mood-text">${moodText}</span>
                    </div>
                </div>
                
                ${entry.gratitude.length > 0 ? `
                <div class="gratitude-list mb-3">
                    <div class="fw-bold small text-muted mb-1">I'm grateful for:</div>
                    <ul class="mb-0 ps-3">
                        ${entry.gratitude.filter(Boolean).map(item => 
                            `<li>${item}</li>`).join('')}
                    </ul>
                </div>` : ''}
                
                ${entry.entry ? `
                <div class="entry-content">
                    <div class="fw-bold small text-muted mb-1">Reflection:</div>
                    <div>${entry.entry.replace(/\n/g, '<br>')}</div>
                </div>` : ''}
            </div>`;
    }
    
    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed bottom-0 end-0 m-3`;
        notification.role = 'alert';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // Event listeners
    journalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        saveEntry();
    });
    
    saveDraftBtn.addEventListener('click', (e) => {
        e.preventDefault();
        saveEntry(true);
    });
    
    // Initial render
    setMood(3);
    renderEntries();
});
</script>
{% endblock %}