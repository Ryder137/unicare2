{% extends "admin/base.html" %}

{% block admin_title %}User Management{% endblock %}

{% block content %}
<!-- Debug Info -->
<div class="alert alert-info">
    <h4>Debug Information</h4>
    <p>Users count: {{ users|length }}</p>
    {% if users and users|length > 0 %}
        <p>First user keys: {{ users[0].keys()|list|tojson }}</p>
        <p>First user data: {{ users[0]|tojson }}</p>
    {% else %}
        <p>No users found</p>
    {% endif %}
    <p>User counts: {{ user_counts|tojson }}</p>
</div>

<!-- Add User Button -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">User Management</h1>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="fas fa-plus-circle me-1"></i> Add New User
        </button>
    </div>
</div>

<!-- User Stats -->
<div class="row mb-4">
    <div class="col-12">
        <div class="row">
            <div class="col-md-3">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Total Users</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ user_counts.total }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-users fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Clients</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ user_counts.clients }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-user fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    Psychologists</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ user_counts.psychologists }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-user-md fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Admins</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ user_counts.admins }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-user-shield fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Table -->
<div class="card shadow">
    <div class="card-header py-3">
        <ul class="nav nav-tabs card-header-tabs" id="userTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" aria-controls="all" aria-selected="true">
                    All Users
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients" type="button" role="tab" aria-controls="clients" aria-selected="false">
                    Clients
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="psychologists-tab" data-bs-toggle="tab" data-bs-target="#psychologists" type="button" role="tab" aria-controls="psychologists" aria-selected="false">
                    Psychologists
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button" role="tab" aria-controls="admins" aria-selected="false">
                    Admins
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="counselors-tab" data-bs-toggle="tab" data-bs-target="#counselors" type="button" role="tab" aria-controls="counselors" aria-selected="false">
                    Guidance Counselors
                </button>
            </li>
        </ul>
    </div>
    
    <div class="card-body">
        <div class="tab-content" id="userTabsContent">
            <!-- All Users Tab -->
            <div class="tab-pane fade show active" id="all" role="tabpanel" aria-labelledby="all-tab">
                <div class="table-responsive">
                    <table class="table table-bordered user-table" id="allUsersTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Debug output -->
                            <div class="alert alert-info">
                                <h5>Debug Information</h5>
                                <p>Total users: {{ users|length }}</p>
                                <p>Users data type: {{ users|type }}</p>
                                {% if users and users|length > 0 %}
                                    <p>First user keys: {{ users[0].keys()|list }}</p>
                                    <p>First user data: {{ users[0]|tojson }}</p>
                                {% else %}
                                    <p>No users found in the database</p>
                                {% endif %}
                            </div>
                            {% if users and users|length > 0 %}
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.first_name or 'N/A' }} {{ user.last_name or '' }}</td>
                                    <td>{{ user.email or 'N/A' }}</td>
                                    <td>
                                        {% if user.is_admin %}
                                            <span class="badge bg-warning">Admin</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Client</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {{ 'bg-success' if not user.is_admin else 'bg-secondary' }}">
                                            {{ 'Active' if not user.is_admin else 'Admin' }}
                                        </span>
                                    </td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-info view-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="{{ 'true' if user.is_admin else 'false' }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning edit-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="{{ 'true' if user.is_admin else 'false' }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="{{ 'true' if user.is_admin else 'false' }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Clients Tab -->
            <div class="tab-pane fade" id="clients" role="tabpanel" aria-labelledby="clients-tab">
                <div class="table-responsive">
                    <table class="table table-bordered user-table" id="clientsTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in all_users if user.user_type == 'client' %}
                            <tr>
                                <td>{{ user.first_name }} {{ user.last_name }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <span class="badge {{ 'bg-success' if user.is_active else 'bg-danger' }}">
                                        {{ 'Active' if user.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-info view-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="{{ 'true' if user.is_admin else 'false' }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning edit-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="{{ 'true' if user.is_admin else 'false' }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="{{ 'true' if user.is_admin else 'false' }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center">No clients found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Psychologists Tab -->
            <div class="tab-pane fade" id="psychologists" role="tabpanel" aria-labelledby="psychologists-tab">
                <div class="table-responsive">
                    <table class="table table-bordered user-table" id="psychologistsTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Specialization</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in all_users if user.user_type == 'psychologist' %}
                            <tr>
                                <td>{{ user.first_name }} {{ user.last_name }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.specialization or 'N/A' }}</td>
                                <td>
                                    <span class="badge {{ 'bg-success' if user.is_active else 'bg-danger' }}">
                                        {{ 'Active' if user.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info view-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="{{ 'true' if user.is_admin else 'false' }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning edit-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="{{ 'true' if user.is_admin else 'false' }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="{{ 'true' if user.is_admin else 'false' }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center">No psychologists found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Admins Tab -->
            <div class="tab-pane fade" id="admins" role="tabpanel" aria-labelledby="admins-tab">
                <div class="table-responsive">
                    <table class="table table-bordered user-table" id="adminsTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in all_users if user.user_type == 'admin' %}
                            <tr>
                                <td>{{ user.first_name }} {{ user.last_name }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <span class="badge {{ 'bg-warning' if user.is_super_admin else 'bg-info' }}">
                                        {{ 'Super Admin' if user.is_super_admin else 'Admin' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-success' if user.is_active else 'bg-danger' }}">
                                        {{ 'Active' if user.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info view-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="true">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning edit-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="true">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-user" 
                                            data-user-id="{{ user.id }}" 
                                            data-is-admin="true">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center">No admins found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1" aria-labelledby="viewUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewUserModalLabel">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Content will be loaded dynamically via JavaScript -->
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Confirmation Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteUserModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="edit_user_id" name="user_id">
                    <input type="hidden" id="edit_user_type" name="user_type">
                    
                    <div class="mb-3">
                        <label for="edit_first_name" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_last_name" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="edit_email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_is_active" class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="edit_is_active" name="is_active" value="1">
                            Active
                        </label>
                    </div>
                    <div id="editSpecializationField" class="mb-3" style="display: none;">
                        <label for="edit_specialization" class="form-label">Specialization</label>
                        <input type="text" class="form-control" id="edit_specialization" name="specialization">
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm" method="POST" action="{{ url_for('admin.add_user') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="user_type" class="form-label">User Type</label>
                        <select class="form-select" id="user_type" name="user_type" required>
                            <option value="">Select user type...</option>
                            <option value="client">Client</option>
                            <option value="psychologist">Psychologist</option>
                            <option value="guidance_counselor">Guidance Counselor</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3" id="specializationField" style="display: none;">
                        <label for="specialization" class="form-label">Specialization</label>
                        <input type="text" class="form-control" id="specialization" name="specialization" placeholder="e.g., Clinical Psychology">
                    </div>
                    <div class="mb-3">
                        <label for="first_name" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="first_name" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="last_name" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="last_name" name="last_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
// Debug: Log table data and initialization
$(document).ready(function() {
    console.log('Document ready');
    
    // Log table data
    $('.user-table').each(function() {
        const $table = $(this);
        const tableId = $table.attr('id') || 'unknown';
        const $rows = $table.find('tbody tr');
        console.log(`Table: ${tableId}, Rows: ${$rows.length}`);
        
        // Log first row data if exists
        if ($rows.length > 0) {
            const $firstRow = $rows.first();
            const rowData = $firstRow.find('td').map(function() {
                return $(this).text().trim();
            }).get();
            console.log(`First row data (${tableId}):`, rowData);
        }
    });
    
    // Initialize DataTables with error handling
    try {
        $('.user-table').DataTable({
            responsive: true,
            pageLength: 10,
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search..."
            }
        });
        console.log('DataTables initialized successfully');
    } catch (e) {
        console.error('Error initializing DataTables:', e);
    }
});
</script>
<script>
// Make sure jQuery is loaded
if (typeof jQuery == 'undefined') {
    console.error('jQuery is not loaded!');
// Initialize when document is ready
$(document).ready(function() {
    'use strict';
    
    console.log('jQuery version:', jQuery.fn.jquery);
    
    try {
            // Common DataTable configuration
            const commonDtConfig = {
                "pageLength": 10,
                "responsive": true,
                "language": {
                    "search": "_INPUT_",
                    "searchPlaceholder": "Search...",
                    "lengthMenu": "Show _MENU_ entries",
                    "zeroRecords": "No matching records found",
                    "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                    "infoEmpty": "No entries available",
                    "infoFiltered": "(filtered from _MAX_ total entries)"
                }
            };

            // Initialize DataTable for All Users
            if ($('#allUsersTable').length) {
                $('#allUsersTable').DataTable($.extend(true, {}, commonDtConfig, {
                    "order": [[4, "desc"]],
                    "columnDefs": [
                        { "orderable": false, "targets": [5] }
                    ]
                }));
            }

            // Initialize DataTable for Clients
            if ($('#clientsTable').length) {
                $('#clientsTable').DataTable($.extend(true, {}, commonDtConfig, {
                    "order": [[3, "desc"]],
                    "columnDefs": [
                        { "orderable": false, "targets": [4] }
                    ]
                }));
            }

            // Initialize DataTable for Psychologists
            if ($('#psychologistsTable').length) {
                $('#psychologistsTable').DataTable($.extend(true, {}, commonDtConfig, {
                    "order": [[3, "desc"]],
                    "columnDefs": [
                        { "orderable": false, "targets": [4] }
                    ]
                }));
            }

            // Initialize DataTable for Admins
            if ($('#adminsTable').length) {
                $('#adminsTable').DataTable($.extend(true, {}, commonDtConfig, {
                    "order": [[3, "desc"]],
                    "columnDefs": [
                        { "orderable": false, "targets": [4] }
                    ]
                }));
            }

            // Show/hide specialization field based on user type
            const userTypeSelect = document.getElementById('user_type');
            const specializationField = document.getElementById('specializationField');
            
            if (userTypeSelect && specializationField) {
                // Update visibility based on current value
                const updateSpecializationField = function() {
                    specializationField.style.display = (userTypeSelect.value === 'psychologist') ? 'block' : 'none';
                };
                
                // Add event listener
                userTypeSelect.addEventListener('change', updateSpecializationField);
                
                // Set initial state
                updateSpecializationField();
            }
            
            // Debug: Log DataTables version and check if it's loaded
            console.log('jQuery version:', $.fn.jquery);
            console.log('DataTables version:', $.fn.DataTable ? $.fn.DataTable.version : 'Not loaded');
            
            // Check if DataTables is properly loaded
            if (typeof $.fn.DataTable !== 'function') {
                console.error('DataTables is not loaded!');
                return;
            }
            
            // Handle view user action
            $(document).on('click', '.view-user', function() {
                const userId = $(this).data('user-id');
                const isAdmin = $(this).data('is-admin') === 'true';
                const userType = isAdmin ? 'admin' : 'client';
                
                console.log(`View user ${userId} (type: ${userType})`);
                
                // For now, just show the modal
                $('#viewUserModal').modal('show');
            });
            
            // Handle edit user action
            $(document).on('click', '.edit-user', function() {
                const userId = $(this).data('user-id');
                const isAdmin = $(this).data('is-admin') === 'true';
                const userType = isAdmin ? 'admin' : 'client';
                const $row = $(this).closest('tr');
                
                console.log(`Edit user ${userId} (type: ${userType})`);
                
                // Get user data from the row
                const userData = {
                    id: userId,
                    user_type: userType,
                    first_name: $row.find('td:eq(0)').text().trim(),
                    last_name: $row.find('td:eq(1)').text().trim(),
                    email: $row.find('td:eq(2)').text().trim(),
                    is_active: $row.find('.badge').hasClass('bg-success')
                };
                
                // Populate the form
                $('#edit_user_id').val(userData.id);
                $('#edit_user_type').val(userData.user_type);
                $('#edit_first_name').val(userData.first_name);
                $('#edit_last_name').val(userData.last_name);
                $('#edit_email').val(userData.email);
                $('#edit_is_active').prop('checked', userData.is_active);
                
                // Show/hide specialization field based on user type
                if (userType === 'psychologist') {
                    const specialization = $row.find('td:eq(3)').text().trim();
                    $('#edit_specialization').val(specialization);
                    $('#editSpecializationField').show();
                } else {
                    $('#editSpecializationField').hide();
                }
                
                // Show the modal
                $('#editUserModal').modal('show');
            });
            
            // Handle edit form submission
            $('#editUserForm').on('submit', function(e) {
                e.preventDefault();
                
                const formData = $(this).serialize();
                const userId = $('#edit_user_id').val();
                const userType = $('#edit_user_type').val();
                
                console.log(`Saving changes for user ${userId} (type: ${userType})`);
                console.log('Form data:', formData);
                
                // Here you would typically make an AJAX call to update the user
                // For now, we'll just close the modal and show a success message
                $('#editUserModal').modal('hide');
                
                // Show success message
                alert('User updated successfully!');
                
                // In a real implementation, you would update the table row with the new data
                // and refresh the DataTable
            });
            
            // Handle delete user action
            $(document).on('click', '.delete-user', function() {
                const userId = $(this).data('user-id');
                const isAdmin = $(this).data('is-admin') === 'true';
                const userType = isAdmin ? 'admin' : 'client';
                const userName = $(this).closest('tr').find('td:first').text().trim();
                
                console.log(`Delete user ${userId} (type: ${userType})`);
                
                // Update the modal with user info
                $('#deleteUserModal .modal-body').html(`
                    <p>Are you sure you want to delete the following user?</p>
                    <p><strong>Name:</strong> ${userName}</p>
                    <p><strong>ID:</strong> ${userId}</p>
                    <p><strong>Type:</strong> ${userType}</p>
                    <p class="text-danger">This action cannot be undone!</p>
                `);
                
                // Set up the delete button
                $('#confirmDeleteBtn').off('click').on('click', function() {
                    console.log(`Confirmed delete for user ${userId}`);
                    // Here you would typically make an AJAX call to delete the user
                    // For now, we'll just close the modal
                    $('#deleteUserModal').modal('hide');
                    
                    // Show a success message (replace with actual AJAX call)
                    alert(`User ${userName} (${userId}) would be deleted here.`);
                });
                
                // Show the modal
                $('#deleteUserModal').modal('show');
            });
            
            // Initialize the view user modal
            $(document).on('show.bs.modal', '#viewUserModal', function(event) {
                const button = $(event.relatedTarget);
                const userId = button.data('user-id');
                const userType = button.data('user-type') || 'client';
                const modal = $(this);
                const modalBody = modal.find('.modal-body');
                
                // Show loading state
                modalBody.html(`
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading user data...</p>
                    </div>
                `);
                
                // In a real implementation, you would fetch the user data here
                // For now, we'll simulate a successful response
                setTimeout(() => {
                    // This is a mock response - replace with actual API call
                    const mockUserData = {
                        id: userId,
                        first_name: 'John',
                        last_name: 'Doe',
                        email: 'john.doe@example.com',
                        user_type: userType,
                        is_active: true,
                        created_at: new Date().toISOString(),
                        last_login: new Date().toISOString(),
                        is_admin: isAdmin,
                        is_super_admin: isAdmin && Math.random() > 0.5,
                        specialization: userType === 'psychologist' ? 'Clinical Psychology' : null
                    };
                    
                    // Format the user data for display
                    let html = `
                        <div class="row mb-4">
                            <div class="col-md-3 text-center">
                                <div class="avatar-circle bg-primary bg-opacity-10 mb-3" style="width: 80px; height: 80px; margin: 0 auto; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user text-primary" style="font-size: 2.5rem;"></i>
                                </div>
                                <h5 class="mb-1">${mockUserData.first_name} ${mockUserData.last_name}</h5>
                                <span class="badge ${mockUserData.user_type === 'admin' ? 'bg-warning' : mockUserData.user_type === 'psychologist' ? 'bg-info' : 'bg-secondary'}">
                                    ${mockUserData.user_type.charAt(0).toUpperCase() + mockUserData.user_type.slice(1)}
                                </span>
                                <div class="mt-2">
                                    <span class="badge ${mockUserData.is_active ? 'bg-success' : 'bg-danger'}">
                                        ${mockUserData.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                    ${mockUserData.is_super_admin ? '<span class="badge bg-dark ms-1">Super Admin</span>' : ''}
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">Email</h6>
                                        <p class="mb-0">${mockUserData.email}</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">User ID</h6>
                                        <p class="mb-0">${mockUserData.id}</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">Member Since</h6>
                                        <p class="mb-0">${new Date(mockUserData.created_at).toLocaleDateString()}</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">Last Login</h6>
                                        <p class="mb-0">${mockUserData.last_login ? new Date(mockUserData.last_login).toLocaleString() : 'Never'}</p>
                                    </div>`;
                    
                    // Add additional fields for specific user types
                    if (mockUserData.user_type === 'psychologist' && mockUserData.specialization) {
                        html += `
                                    <div class="col-12">
                                        <hr>
                                        <h5 class="mb-3">Professional Information</h5>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">Specialization</h6>
                                        <p class="mb-0">${mockUserData.specialization || 'N/A'}</p>
                                    </div>`;
                    }
                    
                    // Close the HTML structure
                    html += `
                                </div>
                            </div>
                        </div>`;
                    
                    // Update the modal content
                    modalBody.html(html);
                    
                }, 1000); // Simulate network delay
            });
            
            // Log table count before initialization
            const tableCount = $('.user-table').length;
            console.log(`Found ${tableCount} tables to initialize`);
            
            // Prevent default form submission
            $('form').on('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
            
            // Fix tab navigation
            $('a[data-bs-toggle="tab"]').on('click', function(e) {
                e.preventDefault();
                $(this).tab('show');
            });
            
            // Initialize DataTables for all user tables
            $('.user-table').each(function(index) {
                const tableId = $(this).attr('id') || `table-${index}`;
                console.log(`Initializing table: ${tableId}`);
                
                try {
                    const dataTable = $(this).DataTable({
                        "pageLength": 10,
                        "responsive": true,
                        "order": [[0, 'asc']],
                        "language": {
                            "search": "_INPUT_",
                            "searchPlaceholder": "Search...",
                            "lengthMenu": "Show _MENU_ entries",
                            "zeroRecords": "No matching records found",
                            "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                            "infoEmpty": "No entries available",
                            "infoFiltered": "(filtered from _MAX_ total entries)"
                        },
                        "columnDefs": [
                            { "orderable": false, "targets": -1 } // Disable sorting on action column
                        ]
                    });
                    
                    // Log table data after initialization
                    console.log(`Table ${tableId} initialized with ${dataTable.rows().count()} rows`);
                } catch (e) {
                    console.error(`Error initializing table ${tableId}:`, e);
                }
            });
            
            // Search functionality for each table
            $('.dataTables_filter input').unbind().keyup(function() {
                const table = $(this).closest('.tab-pane').find('.user-table').DataTable();
                table.search(this.value).draw();
            });
            
            // Refresh DataTables when switching tabs
            $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                $.fn.dataTable.tables({visible: true, api: true}).columns.adjust();
            });
            
            // Handle view user modal
            $('#viewUserModal').on('show.bs.modal', function(event) {
                const button = $(event.relatedTarget);
                const userId = button.data('user-id');
                const userType = button.data('user-type');
                const modal = $(this);
                const modalBody = modal.find('.modal-body');
                
                // Show loading state
                modalBody.html(`
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `);
                
                // Fetch user data
                $.get(`/admin/users/${userType}/${userId}`, function(data) {
                    // Format the user data for display
                    let html = `
                        <div class="row mb-4">
                            <div class="col-md-3 text-center">
                                <div class="avatar-circle bg-primary bg-opacity-10 mb-3" style="width: 80px; height: 80px; margin: 0 auto;">
                                    <i class="bi bi-person-fill text-primary" style="font-size: 2.5rem; line-height: 80px;"></i>
                                </div>
                                <h5 class="mb-1">${data.first_name} ${data.last_name}</h5>
                                <span class="badge ${data.user_type === 'admin' ? 'bg-warning' : data.user_type === 'psychologist' ? 'bg-info' : 'bg-secondary'}">
                                    ${data.user_type.charAt(0).toUpperCase() + data.user_type.slice(1)}
                                </span>
                                <div class="mt-2">
                                    <span class="badge ${data.is_active ? 'bg-success' : 'bg-danger'}">
                                        ${data.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">Email</h6>
                                        <p class="mb-0">${data.email}</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">Member Since</h6>
                                        <p class="mb-0">${new Date(data.created_at).toLocaleDateString()}</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">Last Login</h6>
                                        <p class="mb-0">${data.last_login ? new Date(data.last_login).toLocaleString() : 'Never'}</p>
                                    </div>`;

                    // Add additional fields for psychologists
                    if (data.user_type === 'psychologist' && data.specialization) {
                        html += `
                                    <div class="col-12">
                                        <hr>
                                        <h5 class="mb-3">Professional Information</h5>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">Specialization</h6>
                                        <p class="mb-0">${data.specialization || 'N/A'}</p>
                                    </div>`;
                        
                        if (data.license_number) {
                            html += `
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">License Number</h6>
                                        <p class="mb-0">${data.license_number}</p>
                                    </div>`;
                        }
                        
                        if (data.bio) {
                            html += `
                                    <div class="col-12 mb-3">
                                        <h6 class="text-muted mb-1">Bio</h6>
                                        <p class="mb-0">${data.bio}</p>
                                    </div>`;
                        }
                    }
                    
                    // Add additional fields for admins
                    if (data.user_type === 'admin') {
                        html += `
                                    <div class="col-12">
                                        <hr>
                                        <h5 class="mb-3">Admin Information</h5>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">Role</h6>
                                        <p class="mb-0">
                                            <span class="badge ${data.is_super_admin ? 'bg-warning' : 'bg-info'}">
                                                ${data.is_super_admin ? 'Super Admin' : 'Admin'}
                                            </span>
                                        </p>
                                    </div>`;
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>`;
                    
                    modalBody.html(html);
                }).fail(function() {
                    modalBody.html(`
                        <div class="alert alert-danger">
                            Failed to load user data. Please try again.
                        </div>
                    `);
                });
            });
    
            // Handle delete modal
            $(document).on('show.bs.modal', '#deleteUserModal', function(event) {
                const button = $(event.relatedTarget);
                const userId = button.data('user-id');
                const userType = button.data('user-type');
                const form = $('#deleteUserForm');
                form.attr('action', `/admin/users/${userType}/${userId}/delete`);
                
                // Update the modal title with the user type
                const modal = $(this);
                modal.find('.modal-title').text(`Delete ${userType.charAt(0).toUpperCase() + userType.slice(1)} Account`);
            });
            
        } catch (error) {
            console.error('Error in user management scripts:', error);
        }
    });
}
</script>
{% endblock %}
