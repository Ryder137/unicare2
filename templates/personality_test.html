{% extends "base.html" %}

{% block content %}
<div class="personality-test-container py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div id="test-intro" class="text-center py-4">
                            <h2>Welcome to the Personality Assessment</h2>
                            <p class="lead">This test will help you understand your personality across five major dimensions.</p>
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Note on Accuracy:</strong> This is a simplified version of the Big Five personality test. 
                                For a more accurate assessment, consider consulting with a mental health professional or 
                                taking a comprehensive, scientifically validated personality assessment.
                            </div>
                            <p>You'll be presented with a series of statements. Please indicate how much you agree or disagree with each statement.</p>
                            {% if is_guest %}
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle me-2"></i>You're taking this test as a guest. <a href="{{ url_for('user_login') }}" class="alert-link">Sign in</a> to save your results and track your progress.
                            </div>
                            {% endif %}
                            <button id="start-test" class="btn btn-primary btn-lg mt-3 text-white">Begin Test</button>
                        </div>

                        <form id="personality-test-form" class="d-none" action="{{ url_for('submit_personality_test') }}" method="POST">
                            <div id="question-container">
                                <!-- Questions will be loaded here by JavaScript -->
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" id="prev-btn" class="btn btn-outline-secondary text-secondary" disabled>Previous</button>
                                <div>
                                    <span id="question-counter">Question 1 of 50</span>
                                </div>
                                <button type="button" id="next-btn" class="btn btn-primary text-white">Next</button>
                                <button type="submit" id="submit-btn" class="btn btn-success text-white d-none">Submit Test</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
        // DASS-21 Assessment Questions (Depression, Anxiety, Stress Scale)
        const questions = [
            { text: "I found it hard to wind down", trait: "stress", reversed: false },
            { text: "I was aware of dryness of my mouth", trait: "anxiety", reversed: false },
            { text: "I couldn't seem to experience any positive feeling at all", trait: "depression", reversed: false },
            { text: "I experienced breathing difficulty (e.g., excessively rapid breathing, breathlessness in the absence of physical exertion)", trait: "anxiety", reversed: false },
            { text: "I found it difficult to work up the initiative to do things", trait: "depression", reversed: false },
            { text: "I tended to over-react to situations", trait: "stress", reversed: false },
            { text: "I experienced trembling (e.g., in the hands)", trait: "anxiety", reversed: false },
            { text: "I felt that I was using a lot of nervous energy", trait: "stress", reversed: false },
            { text: "I was worried about situations in which I might panic and make a fool of myself", trait: "anxiety", reversed: false },
            { text: "I felt that I had nothing to look forward to", trait: "depression", reversed: false },
            { text: "I found myself getting agitated", trait: "stress", reversed: false },
            { text: "I found it difficult to relax", trait: "stress", reversed: false },
            { text: "I felt down-hearted and blue", trait: "depression", reversed: false },
            { text: "I was intolerant of anything that kept me from getting on with what I was doing", trait: "stress", reversed: false },
            { text: "I felt I was close to panic", trait: "anxiety", reversed: false },
            { text: "I was unable to become enthusiastic about anything", trait: "depression", reversed: false },
            { text: "I felt I wasn't worth much as a person", trait: "depression", reversed: false },
            { text: "I felt that I was rather touchy", trait: "stress", reversed: false },
            { text: "I was aware of the action of my heart in the absence of physical exertion (e.g., sense of heart rate increase, heart missing a beat)", trait: "anxiety", reversed: false },
            { text: "I felt scared without any good reason", trait: "anxiety", reversed: false },
            { text: "I felt that life was meaningless", trait: "depression", reversed: false }
        ];
        
        // Shuffle questions to randomize order
        questions.sort(() => Math.random() - 0.5);

        const testForm = document.getElementById('personality-test-form');
        const questionContainer = document.getElementById('question-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const questionCounter = document.getElementById('question-counter');
        const startTestBtn = document.getElementById('start-test');
        const testIntro = document.getElementById('test-intro');

        let currentQuestion = 0;
        const answers = [];

        // Initialize the test
        function startTest() {
            testIntro.classList.add('d-none');
            testForm.classList.remove('d-none');
            showQuestion();
        }

        // Display the current question
        function showQuestion() {
            if (currentQuestion >= questions.length) {
                showResults();
                return;
            }

            const question = questions[currentQuestion];
            questionContainer.innerHTML = `
                <div class="card mb-4">
                    <div class="card-body">
                        <h3 class="h5 mb-4">${question.text}</h3>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="q${currentQuestion}" id="q${currentQuestion}_0" value="0" checked>
                                <label class="form-check-label" for="q${currentQuestion}_0">Did not apply to me at all</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="q${currentQuestion}" id="q${currentQuestion}_1" value="1">
                                <label class="form-check-label" for="q${currentQuestion}_1">Applied to me to some degree, or some of the time</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="q${currentQuestion}" id="q${currentQuestion}_2" value="2">
                                <label class="form-check-label" for="q${currentQuestion}_2">Applied to me to a considerable degree or a good part of time</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="q${currentQuestion}" id="q${currentQuestion}_3" value="3">
                                <label class="form-check-label" for="q${currentQuestion}_3">Applied to me very much or most of the time</label>
                            </div>
                    </div>
                </div>
            `;

            updateNavigation();
        }

        // Update navigation buttons and counter
        function updateNavigation() {
            questionCounter.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
            
            prevBtn.disabled = currentQuestion === 0;
            nextBtn.classList.toggle('d-none', currentQuestion === questions.length - 1);
            submitBtn.classList.toggle('d-none', currentQuestion !== questions.length - 1);
        }

        // Calculate DASS-21 scores (Depression, Anxiety, Stress)
        function calculateResults() {
            // Initialize DASS-21 scores
            const scores = {
                'depression': 0,
                'anxiety': 0,
                'stress': 0
            };
            
            const itemCounts = {
                'depression': 0,
                'anxiety': 0,
                'stress': 0
            };
            
            // Calculate raw scores for each subscale
            answers.forEach(answer => {
                if (answer && answer.trait && (answer.answer === 0 || answer.answer)) {
                    const answerValue = Math.max(0, Math.min(3, parseInt(answer.answer) || 0));
                    scores[answer.trait] += answerValue;
                    itemCounts[answer.trait]++;
                }
            });
            
            // Convert to DASS-21 scores (multiply by 2 for full DASS-42 equivalent)
            const results = {
                'depression': scores['depression'] * 2,
                'anxiety': scores['anxiety'] * 2,
                'stress': scores['stress'] * 2
            };
            
            // DASS-21 severity ratings
            const descriptions = {
                'depression': {
                    'normal': 'Your responses indicate normal levels of depressive symptoms.',
                    'mild': 'Your responses suggest mild depressive symptoms.',
                    'moderate': 'Your responses suggest moderate depressive symptoms.',
                    'severe': 'Your responses suggest severe depressive symptoms.',
                    'extremely_severe': 'Your responses suggest extremely severe depressive symptoms.'
                },
                'anxiety': {
                    'normal': 'Your responses indicate normal levels of anxiety.',
                    'mild': 'Your responses suggest mild anxiety symptoms.',
                    'moderate': 'Your responses suggest moderate anxiety symptoms.',
                    'severe': 'Your responses suggest severe anxiety symptoms.',
                    'extremely_severe': 'Your responses suggest extremely severe anxiety symptoms.'
                },
                'stress': {
                    'normal': 'Your responses indicate normal levels of stress.',
                    'mild': 'Your responses suggest mild stress symptoms.',
                    'moderate': 'Your responses suggest moderate stress symptoms.',
                    'severe': 'Your responses suggest severe stress symptoms.',
                    'extremely_severe': 'Your responses suggest extremely severe stress symptoms.'
                }
            };

            // Determine severity level for each DASS-21 subscale
            const severityLevels = {
                'depression': (score) => {
                    if (score < 10) return 'normal';
                    if (score < 14) return 'mild';
                    if (score < 21) return 'moderate';
                    if (score < 28) return 'severe';
                    return 'extremely_severe';
                },
                'anxiety': (score) => {
                    if (score < 8) return 'normal';
                    if (score < 10) return 'mild';
                    if (score < 15) return 'moderate';
                    if (score < 20) return 'severe';
                    return 'extremely_severe';
                },
                'stress': (score) => {
                    if (score < 15) return 'normal';
                    if (score < 19) return 'mild';
                    if (score < 26) return 'moderate';
                    if (score < 34) return 'severe';
                    return 'extremely_severe';
                }
            };

            // Prepare results with severity levels and descriptions
            const formattedResults = {};
            Object.keys(results).forEach(scale => {
                const score = results[scale];
                const level = severityLevels[scale](score);
                formattedResults[scale] = {
                    score: score,
                    level: level,
                    description: descriptions[scale][level]
                };
            });

            return formattedResults;
        }
        
        // Show results page
        function showResults() {
            // Calculate results
            const results = calculateResults();
            
            // Display results with detailed interpretation
            questionContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#4a6cf7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <h2>Test Completed!</h2>
                    <p class="lead">Thank you for completing the personality assessment.</p>
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> These results are based on your self-reported answers and should be 
                        interpreted as a general guide rather than a definitive assessment of your personality.
                    </div>
                    
                    <div id="results-container" class="mt-4">
                        <h3 class="h4 mb-4">Your Personality Profile</h3>
                        <div class="row justify-content-center">
                            <div class="col-lg-10">
                                ${Object.entries(results).map(([trait, data]) => {
                                    const traitName = trait.charAt(0).toUpperCase() + trait.slice(1);
                                    const isNeuroticism = trait === 'neuroticism';
                                    const progressClass = isNeuroticism ? 
                                        (data.score < 40 ? 'bg-success' : (data.score < 70 ? 'bg-warning' : 'bg-danger')) :
                                        (data.score > 60 ? 'bg-success' : (data.score > 30 ? 'bg-warning' : 'bg-danger'));
                                    
                                    return `
                                    <div class="card mb-4 border-0 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h5 class="card-title mb-0 text-capitalize">${traitName} 
                                                    <span class="badge ${isNeuroticism ? 
                                                        (data.interpretation === 'Low' ? 'bg-success' : 
                                                        (data.interpretation === 'Moderate' ? 'bg-warning' : 'bg-danger')) : 
                                                        (data.interpretation === 'High' ? 'bg-success' : 
                                                        (data.interpretation === 'Moderate' ? 'bg-warning' : 'bg-danger'))
                                                    } ms-2">
                                                        ${data.interpretation}
                                                    </span>
                                                </h5>
                                                <span class="fw-bold">${data.score}%</span>
                                            </div>
                                            <div class="progress mb-3" style="height: 10px;">
                                                <div class="progress-bar ${progressClass}" role="progressbar" 
                                                    style="width: ${data.score}%" 
                                                    aria-valuenow="${data.score}" 
                                                    aria-valuemin="0" 
                                                    aria-valuemax="100">
                                                </div>
                                            </div>
                                            <p class="card-text mb-0">${data.description}</p>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                                
                                <div class="card border-0 shadow-sm mt-4">
                                    <div class="card-body">
                                        <h5 class="card-title">About Your Results</h5>
                                        <p class="card-text">
                                            This assessment measures five broad dimensions of personality:
                                            <ul>
                                                <li><strong>Openness</strong> - Imagination, creativity, and preference for novelty</li>
                                                <li><strong>Conscientiousness</strong> - Organization, responsibility, and self-discipline</li>
                                                <li><strong>Extraversion</strong> - Sociability, talkativeness, and assertiveness</li>
                                                <li><strong>Agreeableness</strong> - Compassion, cooperativeness, and trust in others</li>
                                                <li><strong>Neuroticism</strong> - Tendency toward emotional instability and negative emotions</li>
                                            </ul>
                                            Remember that personality traits exist on a spectrum, and there are no "good" or "bad" scores. 
                                            These results are just one way to understand your personality.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-primary me-2">Back to Dashboard</a>
                        <button onclick="window.print()" class="btn btn-outline-primary">
                            <i class="bi bi-printer me-1"></i> Print Results
                        </button>
                    </div>
                </div>
            `;
            
            // Create a form to submit the results
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('submit_personality_test') }}";
            
            // Add CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Add answers and results as hidden inputs
            const answersInput = document.createElement('input');
            answersInput.type = 'hidden';
            answersInput.name = 'answers';
            answersInput.value = JSON.stringify(answers);
            form.appendChild(answersInput);
            
            const resultsInput = document.createElement('input');
            resultsInput.type = 'hidden';
            resultsInput.name = 'results';
            resultsInput.value = JSON.stringify(results);
            form.appendChild(resultsInput);
            
            // Submit the form
            document.body.appendChild(form);
            form.submit();
            
            prevBtn.classList.add('d-none');
            nextBtn.classList.add('d-none');
            submitBtn.classList.add('d-none');
        }

        // Event Listeners
        startTestBtn.addEventListener('click', startTest);

        prevBtn.addEventListener('click', () => {
            if (currentQuestion > 0) {
                saveAnswer();
                currentQuestion--;
                showQuestion();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentQuestion < questions.length - 1) {
                saveAnswer();
                currentQuestion++;
                showQuestion();
            }
        });

        submitBtn.addEventListener('click', (e) => {
            e.preventDefault();
            saveAnswer();
            showResults();
        });

        // Save the current answer
        function saveAnswer() {
            const selectedOption = document.querySelector(`input[name="q${currentQuestion}"]:checked`);
            if (selectedOption) {
                answers[currentQuestion] = {
                    questionId: currentQuestion,
                    answer: parseInt(selectedOption.value),
                    trait: questions[currentQuestion].trait,
                    reversed: questions[currentQuestion].reversed
                };
            }
        }
    });
</script>
{% endblock %}
