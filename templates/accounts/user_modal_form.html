{% block content %}
  <div>
    <div class="modal-header">
    <h5 class="modal-title" id="userFormModalLabel">Add New User</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <form id="userForm" method="POST" enctype="multipart/form-data">
      <div class="modal-body">
        <div id="formErrors" class="alert alert-danger d-none"></div>
        <input type="hidden" name="user_id" id="userId" value="{{ user.id if user.id else '' }}">

        <!-- Avatar Upload and Preview -->
        <div class="row mb-3">
          <div class="col-md-12 text-center">
            <label for="avatarInput" class="form-label">Avatar Image</label><br>
            <img id="avatarPreview" 
                src="{{ user.image if user.image else url_for('static', filename='img/avatars/user.png') }}" 
                alt="Avatar Preview" 
                class="rounded-circle mb-2" 
                style="width: 100px; height: 100px; object-fit: cover; border: 2px solid #ddd;">

            {% if user and user.role %}
              {% set role_colors = {
              'admin': 'primary',
              'psychologist': 'success',
              'staff': 'info',
              'client': 'secondary'
              } %}
              <div class="row justify-content-center">
                <span class="col-md-2 badge bg-{{ role_colors[user.role] }} text-center badge-sm" style="font-size: 0.8rem;">
                    {{ user.role | title  }}
                </span>
              </div>
            {% endif %}

            <input class="form-control mt-2" type="file" id="avatarInput" name="avatar" accept="image/*">
          </div>
        </div>
        <div class="row mb-2">
          <div class="col-md-6 mb-2">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" class="form-control" 
                     id="firstName" name="first_name" 
                     value="{{ user.first_name if user.first_name else '' }}"
                     required>
          </div>
          <div class="col-md-6 mb-2">
              <label for="lastName" class="form-label">Last Name</label>
              <input id="lastName" type="text" class="form-control" 
                     name="last_name" 
                     value="{{ user.last_name if user.last_name else '' }}" 
                     required>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6 mb-2">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" class="form-control" 
                   id="email" name="email" 
                   value="{{ user.email if user.email else '' }}"
                   required>
          </div>
          
          {% if not user and not user.role %}
            <div class="col-md-6 mb-2">
              <label for="role" class="form-label">Role</label>
              <select class="form-select" id="role" name="role" required>
                  <option value="" selected disabled>Select Role</option>
                  <option value="admin">Admin</option>
                  <option value="psychologist">Psychologist</option>
                  <option value="staff">Staff</option>
              </select>
            </div>
          {% else %}
            <input type="hidden" name="role" value="{{ user.role }}">
          {% endif %}
        </div>
          
        <div id="passwordFields" class="row mb-2">
          <div class="col-md-6 mb-2">
              <label for="password" class="form-label">Password</label>
          <input type="password" class="form-control" id="password" name="password" minlength="8">
              <div class="form-text" 
                  id="passwordHelperText" 
                  style="display: none;">Leave blank to keep current password
              </div>
          </div>
          <div class="col-md-6 mb-2">
              <label for="confirmPassword" class="form-label">Confirm Password</label>
          <input type="password" class="form-control" id="confirmPassword" name="confirm_password">
          </div>
        </div>

        <!-- Psychologist Specific Fields -->
        {% if user and user.role == 'psychologist' %}
          <div id="psychologistFields" class="mt-4 border-top pt-3" style="display: none;">
            <h6 class="mb-3">Psychologist Information</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="licenseNumber" class="form-label">License Number</label>
                <input type="text" class="form-control" 
                      id="licenseNumber" name="license_number"
                      value="{{ psych_user.license_number if psych_user and psych_user.license_number else None }}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="specialization" class="form-label">Specialization</label>
                <input type="text" class="form-control" id="specialization" name="specialization"
                      value="{{ psych_user.specialization if psych_user and psych_user.specialization else None }}">
              </div>
            </div>
            <div class="col-12 mb-3">
              <label for="education" class="form-label">Education</label>
              <textarea class="form-control" 
                        id="education" name="education" rows="2"
                        >{{ psych_user.education|trim if psych_user and psych_user.education else '' }}
              </textarea>
            </div>
            <div class="col-12 mb-3">
              <label for="bio" class="form-label">Professional Bio</label>
              <textarea class="form-control" 
                        id="bio" name="bio" rows="3"
                        >{{ psych_user.bio|trim if psych_user and psych_user.bio else '' }}</textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="yearsExperience" class="form-label">Years of Experience</label>
                <input type="number" class="form-control" 
                      id="yearsExperience" name="years_experience" min="0"
                      value="{{ psych_user.years_of_experience if psych_user and psych_user.years_of_experience else None }}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="hourlyRate" class="form-label">Hourly Rate (₱)</label>
                <div class="input-group">
                  <span class="input-group-text">₱</span>
                  <input type="number" class="form-control" id="hourlyRate" 
                        name="hourly_rate" min="0" step="0.01"
                        value="{{ psych_user.hourly_rate if psych_user and psych_user.hourly_rate else None }}">
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="form-check form-switch ms-1">
                <input class="form-check-input" type="checkbox" id="isAvailable" name="is_available" checked>
                <label class="form-check-label" for="isAvailable">Available for new clients</label>
              </div>
            </div>
          </div>
        {% endif %}
        
        <div class="row mb-2">
          <div class="form-check col-md-3 form-switch mb-3 ms-3">
            <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
            <label class="form-check-label" for="isActive">Active Account</label>
          </div>
          
          <div id="sendInviteField" class="col-md-6 mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="sendInvite" name="send_invite" checked>
              <label class="form-check-label" for="sendInvite">Send account activation email</label>
            </div>
          </div>
        </div>  
        
      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveUserBtn">
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              Save User
          </button>
      </div>
    </form>
  </div>

  <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body"></div>
  </div>
{% endblock %}

{% block extra_js %}
  <script> 
    $(document).ready(function() {

        function togglePsychologistFields() {
          const role = $('#role').val();
          const psychFields = document.getElementById('psychologistFields');
          if (role === 'psychologist') {
              // Make psychologist fields required
              const requiredFields = psychFields.querySelectorAll('input[type="text"], input[type="number"], textarea, select');
              requiredFields.forEach(field => {
                  field.required = true;
              });
              $('#psychologistFields').show();
          } else {
              // Remove required from psychologist fields
              const requiredFields = psychFields.querySelectorAll('input[type="text"], input[type="number"], textarea, select');
              requiredFields.forEach(field => {
                  field.required = false;
              });

              $('#psychologistFields').hide();
          }
        }

        {% if user %}
          $('#passwordHelperText').show();
          {% if user.role == 'psychologist' %}
            $('#psychologistFields').show();
          {% endif %}
        {% endif %}

        $('#role').on('change', togglePsychologistFields);
        
        function reloadDataTable(){
          $.get('/accounts/users/data', function(response) {
            $('#usersTable').html(response.html);
          });
        }

        // Avatar preview logic
        $('#avatarInput').on('change', function(e) {
          const [file] = this.files;
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              $('#avatarPreview').attr('src', e.target.result);
            };
            reader.readAsDataURL(file);
          } else {
            // Reset to default avatar if no file selected
            $('#avatarPreview').attr('src', "{{ url_for('static', filename='img/default_avatar.png') }}");
          }
        });

        // Form submission
        $('#userForm').on('submit', function(e) {
          e.preventDefault();
          
          const form = $(this);
          const submitBtn = $('#saveUserBtn');
          const spinner = submitBtn.find('.spinner-border');
          const userId = $('#userId').val();
          const url = userId ? `/accounts/user/update/${userId}` : '/accounts/user/create';
          const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

          // Show loading state
          submitBtn.prop('disabled', true);
          spinner.removeClass('d-none');
          
          // Clear previous errors
          $('#formErrors').addClass('d-none').empty();
          $('.is-invalid').removeClass('is-invalid');
          
          // Prepare form data for file upload
          const formData = new FormData(form[0]);

          // Add psychologist fields if role is psychologist or guidance_counselor
          const role = $('#role').val();
          if (role === 'psychologist' || role === 'guidance_counselor') {
              formData.set('license_number', $('#licenseNumber').val());
              formData.set('specialization', $('#specialization').val());
              formData.set('education', $('#education').val());
              formData.set('bio', $('#bio').val());
              formData.set('years_experience', $('#yearsExperience').val());
              formData.set('hourly_rate', $('#hourlyRate').val());
              formData.set('is_available', $('#isAvailable').is(':checked'));
          }

          // Make AJAX call to save the user (multipart/form-data)
          $.ajax({
              url: url,
              type: 'POST',
              data: formData,
              processData: false,
              contentType: false,
              headers: {
                  'X-CSRFToken': csrfToken
              },
              success: function(response) {
                // Hide loading state
                submitBtn.prop('disabled', false);
                spinner.addClass('d-none');

                // Show success message
                const toast = new bootstrap.Toast(document.getElementById('statusToast'));
                $('.toast-body', '#statusToast').html(`
                  <i class="fas fa-check-circle me-2 text-success"></i>
                  ${userId ? 'User updated' : 'User created'} successfully.
                `);
                toast.show();

                reloadDataTable();

                // Hide the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('userFormModal'));
                modal.hide();
              },
              error: function(xhr, status, error) {
                  // Hide loading state
                  submitBtn.prop('disabled', false);
                  spinner.addClass('d-none');
                  
                  console.error('Error:', status, error);
                  console.error('Response:', xhr.responseText);
                  
                  let errorMessage = 'An error occurred. Please try again.';
                  let errorList = $('<ul class="mb-0"></ul>');
                  let response;
                  
                  try {
                      // Try to parse the response as JSON
                      response = xhr.responseJSON || JSON.parse(xhr.responseText);
                  } catch (e) {
                      response = { message: xhr.statusText || errorMessage };
                  }
                  
                  const errors = response.errors || { message: response.error || errorMessage };
                  
                  // Handle field-specific errors
                  for (const [field, message] of Object.entries(errors)) {
                      console.log(`Field: ${field}, Message: ${message}`);
                      if (field !== 'message') {
                          // Convert snake_case to camelCase for matching with field IDs
                          const fieldId = field.split('_').map((word, i) => 
                              i === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1)
                          ).join('');
                          
                          const fieldElement = $(`#${fieldId}`);
                          if (fieldElement.length) {
                              fieldElement.addClass('is-invalid');
                              errorList.append($('<li>').text(`${field}: ${message}`));
                          } else {
                              // If field not found, add to general errors
                              errorList.append($('<li>').text(`${field}: ${message}`));
                          }
                      } else {
                          // Handle general error message
                          errorMessage = message;
                      }
                  }
                  
                  // Show error message in the form
                  const errorContainer = $('#formErrors');
                  
                  // Prepare error display
                  errorContainer
                      .removeClass('d-none alert-success')
                      .addClass('alert-danger')
                      .empty()
                      .append($('<i>').addClass('fas fa-exclamation-circle me-2'))
                      .append('Please correct the following errors:');
                  
                  // Add error list if there are field errors, otherwise show general message
                  if (errorList.children().length > 0) {
                      errorContainer.append(errorList);
                  } else {
                      errorContainer.append($('<p>').addClass('mb-0').text(errorMessage));
                  }
                  
                  // Scroll to the top of the form to show errors
                  $('html, body').animate({
                      scrollTop: errorContainer.offset().top - 20
                  }, 500);
                  
                  // Ensure modal is scrolled to show errors
                  $('.modal-body').scrollTop(0);
              }
          });
        });


      });
  </script>
{% endblock %}